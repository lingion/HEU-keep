<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4C56GQP4ZL');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <title>HEUäººæœ€åçš„å€”å¼º ver.Liquid</title>
    <link rel="icon" href="./favicon.ico">
    <link rel="shortcut icon" href="./favicon.ico">
    <link rel="stylesheet" href="./css/liquid.css">
    <link rel="preload" href="./DINCond-Bold.otf" as="font" type="font/otf" crossorigin>

    <!-- ğŸŒŸ iOS æ·±åº¦é€‚é…æ ·å¼ v2 -->
    <style>
        /* 1. åŸºç¡€é‡ç½®ï¼šåªé’ˆå¯¹æ–‡æœ¬ç±»è¾“å…¥æ¡†ï¼Œæ”¾è¿‡ Checkbox */
        input:not([type="checkbox"]):not([type="file"]), 
        select, 
        textarea {
            -webkit-appearance: none !important;
            appearance: none !important;
            outline: none !important;
            color: #fff !important; /* å¼ºåˆ¶ç™½å­— */
            font-family: inherit;
        }

        /* 2. é€šç”¨è¾“å…¥æ¡†ç»ç’ƒè´¨æ„Ÿ (æ’é™¤æ ‡é¢˜æ è¿™ç§ç‰¹æ®Šç»“æ„çš„) */
        .setDataList li > input:not([type="checkbox"]),
        .setDataList li > select,
        .mini-input,
        .datetime-row input {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 8px !important;
            padding: 6px 10px !important;
            box-shadow: none !important;
        }

        /* 3. ä¿®å¤ Placehoder é¢œè‰² */
        ::placeholder { color: rgba(255, 255, 255, 0.3) !important; }
        ::-webkit-input-placeholder { color: rgba(255, 255, 255, 0.3) !important; }

        /* 4. é‡ç‚¹ä¿®å¤ï¼šKeep æ ‡é¢˜æ  (å»é™¤æ¡†ä¸­æ¡†) */
        .input-with-prefix {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1) !important; /* èƒŒæ™¯åŠ åœ¨å®¹å™¨ä¸Š */
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 8px !important;
            padding: 6px 12px !important;
            width: fit-content !important; /* å®¹å™¨å®½åº¦è‡ªé€‚åº”å†…å®¹ */
            min-width: 200px; /* æœ€å°å®½åº¦ */
            max-width: 100%;
        }
        
        /* æ ‡é¢˜æ é‡Œçš„è¾“å…¥æ¡†ï¼šé€æ˜ã€æ— è¾¹æ¡†ã€è‡ªé€‚åº” */
        .input-with-prefix input {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            height: auto !important;
            min-width: 50px;
            flex: 1; /* å¡«æ»¡å‰©ä½™ç©ºé—´ */
            width: auto; /* å…è®¸ JS è°ƒæ•´å®½åº¦ */
        }

        /* 5. ä¿®å¤ä¸‹æ‹‰ç®­å¤´ */
        select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.6)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            background-size: 12px !important;
            padding-right: 24px !important;
        }

        /* 6. ç¡®ä¿ Checkbox (å¼€å…³) æ­£å¸¸æ˜¾ç¤ºç»¿è‰² */
        input[type="checkbox"] {
            -webkit-appearance: checkbox !important; /* å°è¯•æ¢å¤é»˜è®¤ï¼Œä½†åœ¨ iOS ä¸Š switch æ ·å¼é€šå¸¸éœ€è¦ appearance: auto */
            appearance: auto !important; 
            /* å¦‚æœåŸ CSS åšäº†è‡ªå®šä¹‰ switchï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–ä»£ç ï¼Œåªè¦ä¸å†™ appearance: none å³å¯ */
        }
    </style>
</head>

<body id="body">

    <!-- åŠ¨æ€èƒŒæ™¯å±‚ -->
    <div class="liquid-bg-gradient"></div>
    <div class="liquid-orb orb-1"></div>
    <div class="liquid-orb orb-2"></div>

    <div id="main-div">
        <!-- å·¦ä¾§ï¼šæ‰‹æœºé¢„è§ˆ -->
        <div id="new-Img" class="new-img glass-effect">
            <div class="bgimgwrap" id="bgimgwrap">
                <img src="" class="innerbgimg" id="bg-img" alt="" />
            </div>
            <img src="" id="gui-img" alt="" />
            <div class="portrait-wrap" id="portrait-wrap">
                <img class="portrait" id="portrait" src="" alt="" />
            </div>
            <div class="weather-imgwrap">
                <img src="" class="weather" id="weather" alt="" />
            </div>
            <span class="username" id="username">UserName</span>
            <span class="keep-title" id="keep-title">æˆ·å¤–è·‘æ­¥</span>
            <span class="mile"><span id="mile" class="mile-data">0.00</span><span class="gongli">å…¬é‡Œ</span></span>
            <span class="datetime date" id="date">0000/00/00</span>
            <span class="datetime time" id="time">00:00</span>
            <span class="env temperature" id="temperature">00</span>
            <span class="env humidity" id="humidity">00</span>
            <span class="speed-time speed" id="speed">00'00"</span>
            <span class="speed-time cost-time" id="cost-time">00:00:00</span>
            <span class="speed-time calorie" id="calorie">0</span>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="set-data">
            <div id="messageBox"></div>

            <div class="glass-card export-panel">
                <div class="export-grid">
                    <button onclick="Download(Download1)" class="btn-primary main-save">
                        <span class="icon"></span> ä¿å­˜é«˜æ¸…å›¾ç‰‡
                    </button>
                    <button onclick="Download(Download2)" class="btn-secondary main-preview">
                        <span class="icon"></span> é¢„è§ˆ
                    </button>
                    <button onclick="Download(Download3)" class="btn-tiny backup-btn">å¤‡ç”¨æ–¹æ¡ˆ A</button>
                </div>
            </div>

            <div class="glass-card control-panel">
                <ul class="setDataList">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="input-group">
                        <div class="group-title">åŸºæœ¬ä¿¡æ¯</div>
                        <li>
                            <label>ç”¨æˆ·å</label>
                            <!-- æ·»åŠ  oninput å®ç°å®½åº¦è‡ªé€‚åº” -->
                            <input id="inpt_username" oninput="adjustWidth(this)" onchange="setData()" type="text" placeholder="è¾“å…¥æ˜µç§°">
                        </li>
                        <li>
                            <label>å¤´åƒ</label>
                            <div class="file-action-row">
                                <button onclick="inpt_portrait_onClick()" class="btn-small">ä¸Šä¼ </button>
                                <button onclick="init_portrait()" class="btn-text">æ¢å¤é»˜è®¤</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_portrait" onchange="portrait_inpt()" />
                            </div>
                        </li>
                        <li>
                            <label>æ ‡é¢˜</label>
                            <div class="input-with-prefix">
                                <span class="prefix">keep â€¢ </span>
                                <!-- è¿™é‡Œæ˜¯é‡ç‚¹ï¼šé€æ˜èƒŒæ™¯ + è‡ªåŠ¨å®½åº¦ -->
                                <input id="inpt_keep_title" oninput="adjustWidth(this)" onchange="setData()" type="text" placeholder="æˆ·å¤–è·‘æ­¥">
                            </div>
                        </li>
                    </div>

                    <!-- è¿åŠ¨æ•°æ® -->
                    <div class="input-group">
                        <div class="group-title">è¿åŠ¨æ•°æ®</div>
                        <li>
                            <label>é‡Œç¨‹ (km)</label>
                            <input id="inpt_miles" onchange="setData()" type="text" class="font-mono" placeholder="0.00">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">éšæœºèŒƒå›´:</span>
                            <input type="text" id="min_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Min">
                            <span class="dash">-</span>
                            <input type="text" id="max_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Max">
                        </div>

                        <li style="margin-top: 12px;">
                            <label>é…é€Ÿ</label>
                            <input id="inpt_speeds" onchange="setData()" type="text" class="font-mono" placeholder="5'30&quot;">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">éšæœºèŒƒå›´:</span>
                            <input type="text" id="min_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="å¿«">
                            <span class="dash">-</span>
                            <input type="text" id="max_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="æ…¢">
                        </div>
                    </div>

                    <!-- æ—¶é—´ä¸ç¯å¢ƒ -->
                    <div class="input-group">
                        <div class="group-title">æ—¶é—´ä¸ç¯å¢ƒ</div>
                        <li>
                            <label>æ—¶é—´</label>
                            <div class="datetime-row">
                                <input id="inpt_year" onchange="setData()" type="text" class="year-inp"><span>/</span>
                                <input id="inpt_month" onchange="setData()" type="text" class="date-inp"><span>/</span>
                                <input id="inpt_day" onchange="setData()" type="text" class="date-inp">
                                <span class="spacer"></span>
                                <input id="inpt_hour" onchange="setData()" type="text" class="time-inp"><span>:</span>
                                <input id="inpt_min" onchange="setData()" type="text" class="time-inp">
                            </div>
                        </li>
                        <li>
                            <label>å¤©æ°”</label>
                            <select onchange="weather_Select_onChange()" id="weather_Select">
                                <option value="images/weather1.png">æ™´</option>
                                <option value="images/weather2.png">å¤šäº‘</option>
                                <option value="images/weather3.png">é˜´å¤©</option>
                            </select>
                        </li>
                        <li>
                            <label>æ¸©æ¹¿åº¦</label>
                            <div class="dual-input">
                                <input id="inpt_temperature" onchange="setData()" type="text" class="mini-input" placeholder="Â°C">
                                <span class="unit">Â°C</span>
                                <input id="inpt_humidity" onchange="setData()" type="text" class="mini-input" placeholder="%">
                                <span class="unit"></span>
                            </div>
                        </li>
                    </div>

                    <!-- åœ°å›¾ä¸è½¨è¿¹ -->
                    <div class="input-group">
                        <div class="group-title">åœ°å›¾ä¸è½¨è¿¹</div>
                        <li>
                            <label>èƒŒæ™¯</label>
                            <select onchange="default_bgImgSelect_onChange()" id="default_bgImgSelect">
                                <option value="guiji_Select_1">å—ä½“è‚²åœº</option>
                                <option value="guiji_Select_2">å†›å·¥æ“åœº</option>
                                <option value="guiji_Select_3">åŒ—ä½“è‚²åœº</option>
                            </select>
                        </li>
                        <li>
                            <label>è‡ªå®šä¹‰</label>
                            <div class="file-action-row">
                                <button onclick="inpt_bgimg_onClick()" class="btn-small">ä¸Šä¼ åœ°å›¾</button>
                                <button onclick="init_bgimg()" class="btn-text">é‡ç½®</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_bgimg" onchange="bgimg_inpt()" />
                            </div>
                        </li>

                        <li>
                            <label>æ ·å¼</label>
                            <div class="flex-group" style="display:flex; gap:8px; align-items:center; flex:1;">
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_1" class="guijiSelect">
                                    <option value="['images/bg1_1.png', 'images/bg1_empty2.png']">æ ·å¼ 1</option>
                                    <option value="['images/bg1_2.png', 'images/bg1_empty2.png']">æ ·å¼ 2</option>
                                    <option value="['images/bg1_3.png', 'images/bg1_empty2.png']">æ ·å¼ 3</option>
                                    <option value="['images/bg1_4.png', 'images/bg1_empty2.png']">æ ·å¼ 4</option>
                                    <option value="['images/bg1_5.png', 'images/bg1_empty2.png']">æ ·å¼ 5</option>
                                    <option value="['images/bg1_empty2.png', 'images/bg1_empty2.png']">é»˜è®¤</option>
                                </select>
                                <button onclick="drawMine()" class="btn-small btn-secondary" title="ç”Ÿæˆéšæœºè·¯å¾„">éšæœº</button>
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_2" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg2_empty.png', 'images/bg2_empty.png']">é»˜è®¤</option>
                                </select>
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_3" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg3_empty.png', 'images/bg3_empty.png']">é»˜è®¤</option>
                                </select>
                            </div>
                        </li>

                        <li class="switch-row">
                            <div class="switch-item">
                                <!-- å¤é€‰æ¡†ä¸éœ€è¦é¢å¤–çš„ CSS å°±å¯ä»¥åœ¨ iOS ä¸Šæ˜¾ç¤ºä¸ºç»¿è‰²å¼€å…³ï¼Œåªè¦ä¸åŠ  appearance:none -->
                                <input type="checkbox" id="auto_draw_checkbox" onchange="auto_draw_checkbox_onchange()" checked />
                                <span>è‡ªåŠ¨ç”Ÿæˆ</span>
                            </div>
                            <div class="switch-item">
                                <input type="checkbox" id="inpt_colorchange_checkbox" onchange="inpt_colorchange_checkbox_onchange()" checked />
                                <span>æ¸å˜è‰²</span>
                            </div>
                        </li>
                        <div class="sub-setting" id="bs_prop_inpt_wrap">
                            <span class="sub-label">å˜è‰²æ¦‚ç‡:</span>
                            <input id="inpt_bs_prob" onchange="setData()" type="text" class="mini-input" placeholder="0.5">
                        </div>
                        <div class="sub-setting" id="inpt_bs_range_wrap">
                            <span class="sub-label">å˜è‰²æ­¥é•¿:</span>
                            <input id="inpt_bs_range_min" onchange="setData()" type="text" class="mini-input">
                            <span class="dash">-</span>
                            <input id="inpt_bs_range_max" onchange="setData()" type="text" class="mini-input">
                        </div>
                    </div>

                    <div class="input-group no-border">
                        <li>
                            <label>å®½åº¦</label>
                            <input id="inpt_savePic_width" onchange="setData()" type="text" placeholder="é»˜è®¤" style="min-width:80px;">
                            <span class="unit">px</span>
                        </li>
                    </div>
                </ul>

                <div class="divider"></div>
                <div class="system-actions">
                    <button onclick="storeToIndexedDB(tmp_portrait_src,tmp_bgimg_osrc)" class="btn-text">ä¿å­˜é…ç½®</button>
                    <button onclick="clearIndexedDB()" class="btn-text btn-danger-text">é‡ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/invoke/html2canvas.min.js" defer></script>
    <script src="js/invoke/amapHelper.js" defer></script>
    <script src="js/indexedDB.js" defer></script>
    <script src="js/init.js" defer></script>
    <script src="js/render.js" defer></script>
    <script src="js/select_manner.js" defer></script>
    <script src="js/dataURLtoBlob.js" defer></script>
    <script src="js/img_both_inpt_set.js" defer></script>
    <script src="js/draw_personalization.js" defer></script>
    <script src="js/download_img.js" defer></script>
    <script src="js/localTrackGen.js"></script>
    <script src="js/drawMine.js" defer></script>
    <script src="js/onload.js" defer></script>

    <!-- ğŸŒŸ åŠŸèƒ½è„šæœ¬ï¼šè‡ªåŠ¨å®½åº¦ + ç¦»å±ä¸‹è½½ -->
    <script>
        // 1. è¾“å…¥æ¡†å®½åº¦è‡ªé€‚åº”å‡½æ•°
        function adjustWidth(el) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ span æ¥æµ‹é‡æ–‡å­—å®½åº¦
            let canvas = adjustWidth.canvas || (adjustWidth.canvas = document.createElement("canvas"));
            let context = canvas.getContext("2d");
            let style = window.getComputedStyle(el);
            context.font = style.font; // ä¿æŒå­—ä½“ä¸€è‡´
            
            let text = el.value || el.placeholder;
            let metrics = context.measureText(text);
            
            // è®¾ç½®å®½åº¦ (æ–‡å­—å®½åº¦ + å°‘é‡ padding)
            // è®¾ç½®æœ€å°å®½åº¦é˜²æ­¢å¤ªçª„
            let newWidth = Math.max(50, metrics.width + 20); 
            
            // å¯¹äº Keep æ ‡é¢˜æ ï¼Œæˆ‘ä»¬éœ€è¦æ›´çµæ´»ä¸€ç‚¹
            if(el.id === 'inpt_keep_title') {
                 // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šå¦‚æœæ–‡å­—å¾ˆå°‘ï¼Œå°±ç”¨æœ€å°å®½åº¦ï¼›å¦‚æœæ–‡å­—å¾ˆå¤šï¼Œæ’‘å¼€
                 el.style.width = newWidth + 'px';
            }
        }

        // åˆå§‹åŒ–æ—¶ä¹Ÿè°ƒç”¨ä¸€æ¬¡
        window.addEventListener('load', function() {
            adjustWidth(document.getElementById('inpt_username'));
            adjustWidth(document.getElementById('inpt_keep_title'));
        });


        // 2. ç¦»å±ä¸‹è½½é€»è¾‘ (ä¿æŒä¸å˜)
        window.addEventListener('load', function() {
            console.log("Liquid Fix: Off-screen renderer loaded.");
            window.Download = function(fileNameArg) {
                const targetNode = document.getElementById('new-Img');
                if (!targetNode) return;

                const ghostWrapper = document.createElement('div');
                ghostWrapper.style.position = 'fixed';
                ghostWrapper.style.top = '-9999px';
                ghostWrapper.style.left = '-9999px';
                ghostWrapper.style.zIndex = '-1000';
                ghostWrapper.style.width = targetNode.offsetWidth + 'px';
                document.body.appendChild(ghostWrapper);

                const clonedNode = targetNode.cloneNode(true);
                const originalCanvases = targetNode.querySelectorAll('canvas');
                const clonedCanvases = clonedNode.querySelectorAll('canvas');
                originalCanvases.forEach((orig, index) => {
                    if (clonedCanvases[index]) {
                        const destCtx = clonedCanvases[index].getContext('2d');
                        clonedCanvases[index].width = orig.width;
                        clonedCanvases[index].height = orig.height;
                        destCtx.drawImage(orig, 0, 0);
                    }
                });

                clonedNode.style.transform = 'none';
                clonedNode.style.boxShadow = 'none';
                clonedNode.style.margin = '0';
                clonedNode.style.transition = 'none';

                ghostWrapper.appendChild(clonedNode);

                let fileName = "HEU_Run_" + new Date().toISOString().slice(0,10) + ".png";
                if (typeof fileNameArg === 'function') {
                    try { fileName = fileNameArg(); } catch (e) {}
                } else if (typeof fileNameArg === 'string') {
                    fileName = fileNameArg;
                }
                if (!fileName.endsWith('.png')) fileName += '.png';

                html2canvas(clonedNode, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null,
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    document.body.removeChild(ghostWrapper);
                }).catch(err => {
                    console.error("ç”Ÿæˆå¤±è´¥:", err);
                    alert("ç”Ÿæˆå¤±è´¥");
                    if (document.body.contains(ghostWrapper)) document.body.removeChild(ghostWrapper);
                });
            };
        });
    </script>
</body>
</html>