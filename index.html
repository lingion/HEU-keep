<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>keep运动截图生成</title>
    <style>
        @font-face {
            font-family: 'keeprun';
            src: url(./DINCond-Bold.otf);
        }
        html,
        body {
            width: 100%;
            position: relative;
        }
        * {
            margin: 0;
            padding: 0;
        }
        li {
            list-style: none;
        }
        #main-div {
            margin-top: 0px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        #main-div .new-img {
            position: relative;
            width: 360px;
            height: 718.5px;
        }
        .new-img .gui-img {
            position: absolute;
            transform: scale(0.5);
            top: -50%;
            left: -50%;
            width: 720px;
            height: 1437px;
            vertical-align: top;
        }
        .new-img .bgimgwrap {
            width: 360px;
            height: 718.5px;
            position: absolute;
            display: flex;
            overflow: hidden;
            text-align: center;
            justify-content: center;
			align-items: center;
            top: 0px;
            left: 0px;
        }
        .new-img .innerbgimg {
            width: 360px;
            height: 718.5px;
            margin: 0 auto;
            display: block;
        }
        .new-img .portrait-wrap {
            width: 40px;
            height: 40px;
            position: absolute;
            display: flex;
            overflow: hidden;
            text-align: center;
            justify-content: center;
			align-items: center;
            top: 335px;
            left: 284px;
            border-radius: 20px;
        }
        .new-img .portrait {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            display: block;
        }
        .new-img .weather-imgwrap {
            height: 14.7px;
            width: 14.7px;
            top: 426.7px;
            left: 238px;
            position: absolute;
            display: flex;
            overflow: hidden;
            text-align: center;
            justify-content: center;
			align-items: center;
        }
        
        .new-img .weather {
            width: 14.7px;
            height: 14.7px;
            margin: 0 auto;
            display: block;
        }

        .new-img span {
            position: absolute;
        }
        .username {
            top: 385px;
            right: 32px;
            font-size: 13px;
        }
        .mile {
            color: #57525d;
            font-size: 46px;
            font-family: 'keeprun';
            transform: scale(1.15, 0.95);
            transform-origin: 0 0;
        }
        .mile-par {
            top: 386px;
            right: 315px;
            letter-spacing: -4px;
        }
        .mile-poi {
            top: 386px;
            left: 61px;
        }
        .datetime {
            color: #a2a2a2;
            font-size: 13px;
            font-family: "Segoe UI", Arial, Helvetica, sans-serif;
        }
        .date {
            top: 407px;
            left: 222px;
        }
        .time {
            top: 407px;
            left: 296px;
        }
        .env {
            color: #a2a2a2;
            font-size: 13px;
            font-family: "Segoe UI", Arial, Helvetica, sans-serif;
            transform: scale(1.05, 1);
            letter-spacing: -0.5px;
        }
        .temperature {
            top: 425.5px;
            right: 81px;
        }
        .humidity {
            top: 425.5px;
            right: 33.3px;
        }
        .speed {
            color: #58505b;
            font-size: 27px;
            font-family: 'keeprun';
            transform: scale(1.15, 0.95);
        }
        .spe-min {
            top: 480px;
            left: 31px;
        }
        .spe-sec {
            top: 480px;
            left: 60px;
            letter-spacing: -1px;
        }
        .cost-hour {
            top: 480px;
            left: 139.5px;
        }
        .cost-min {
            top: 480px;
            left: 168px;
        }
        .cost-sec {
            top: 480px;
            left: 199px;
        }
        .calorie {
            top: 479.5px;
            right: 33px;
        }
        .set-data {
            width: 350px;
        }
        input {
            width: 55px;
            height: 24px;
            padding-left: 5px;
            border-radius: 5px;
            border: 1px solid #038957;
            vertical-align: middle;
        }
         :focus-visible {
            outline: #15b77b auto 1px;
        }
        .username-inp {
            width: 125px;
        }
        .img-text {
            position: absolute;
            bottom: -25px;
            left: 50%;
            font-size: 18px;
            transform: translateX(-50%);
        }
        .time-inp {
            width: 20px;
            margin-left: 4px;
            margin-right: 1px;
        }
        button {
            width: 80px;
            height: 30px;
            background-color: #24c68a;
            color: #fff;
            border-radius: 9px;
            line-height: 16px;
            border: 2px solid #c5e4a4;
            font-size: 16px;
        }
        .save-btn {
            width: 180px;
            height: 50px;
            border-radius: 26px;
            line-height: 36px;
            font-size: 20px;
        }
        .init-btn {
            background-color: #c6c6c6;
        }
        .set-data h4,
        .set-data h5 {
            font-size: 24px;
            font-weight: normal;
            color: #24c68a;
        }
        .setDataList li {
            margin-top: 15px;
        }
        .setDataList label {
            color: #24c68a;
        }
        select {
            width: 80px;
            height: 30px;
            background-color: #24c68a;
            color: #fff;
            border-radius: 9px;
            line-height: 16px;
            border: 2px solid #c5e4a4;
            font-size: 16px;
        }
        .warning {
            font-size: 20px;
            padding: 1rem 0 0 0;
        }
        .explanation {
            color: #666;
            padding: 1rem 0 0 0;
            font-size: 15px;
        }
        .explanation a {
            text-decoration: underline;
            color: #0000FF;
        }
        #inpt_colorchange_checkbox {
            width: 20px;
            height: 20px;
            background-color: #24c68a;
            color: #fff;
            border-radius: 9px;
            line-height: 16px;
            border: 2px solid #c5e4a4;
            font-size: 16px;
            margin-left: 4px;
            margin-right: 4px;
        }
		#drawpic_overlay {
			position: fixed;
			left: 0px;
			top: 0px;
			width: 100%;
			height: 100%;
			font-size: 16px;
			background-color: rgba(0, 0, 0, 0.5);
			display: none;
			justify-content: center;
			align-items: center;
		}
		.drawpic_popup {
			background-color: #ffffff;
			width: max-content;
			text-align: center;
		}
        #drawpic_canvas_wrap {
            background-color: #fff;
            position: relative;
            border: 2px solid #999;
            height: 300px;
            width: 250px;
            display: flex;
            overflow: hidden;
            justify-content: center;
        }

    </style>
    
</head>

<body id="body">
    <div id="main-div">
        <div id="new-Img" class="new-img">
            <div class="bgimgwrap">
                <img src="" class="innerbgimg" id="bg-img" />
            </div>
            <img src="images/1.png" class="gui-img" />
            <div class="portrait-wrap">
                <img class="portrait" id="portrait" src="images/default_portrait.png" />
            </div>
            <div class="weather-imgwrap">
                <img src="" class="weather" id="weather" src="" />
            </div>
            <span class="username" id="username">UserName</span>
            <span class="mile mile-par" id="mile-par">0</span>
            <span class="mile mile-poi" id="mile-poi">00</span>
            <span class="datetime date" id="date">0000/00/00</span>
            <span class="datetime time" id="time">00:00</span>
            <span class="env temperature" id="temperature">00</span>
            <span class="env humidity" id="humidity">00</span>
            <span class="speed spe-min" id="spe-min">00</span>
            <span class="speed spe-sec" id="spe-sec">00</span>
            <span class="speed cost-hour" id="cost-hour">00</span>
            <span class="speed cost-min" id="cost-min">00</span>
            <span class="speed cost-sec" id="cost-sec">00</span>
            <span class="speed calorie" id="calorie">0</span>
        </div>
        <div class="set-data">
            <h4>数据设置</h4>
            <ul class="setDataList">
                <li>
                    <label>用户名：</label>
                    <input id="inpt_username" onchange="setData()" type="text" class="username-inp">
                </li>
                <li>
                    <label>头像：</label>
                    <button onclick="inpt_portrait_onClick()" class="inpt-btn">选择图片</button>
                    <input style="display:none;" type="file" accept="image/*" id="inpt_portrait" onchange="portrait_inpt()" />
                    <button onclick="init_portrait()" class="init-btn">恢复默认</button>
                </li>
                <li>
                    <label>公里：</label>
                    <input type="number" min="0" max="20" id="inpt_miles" onchange="setData()" class="mile2-inp">
                </li>
                <li>
                    <label>配速：</label>
                    <input id="inpt_speeds" onchange="setData()" type="text">
                </li>
                <li>
                    <label>时间：</label>
                    <input id="inpt_month" onchange="setData()" type="text" class="time-inp">
                    <span>月</span>
                    <input id="inpt_day" onchange="setData()" type="text" class="time-inp">
                    <span>日</span>
                    <input id="inpt_hour" onchange="setData()" type="text" class="time-inp">
                    <span>时</span>
                    <input id="inpt_min" onchange="setData()" type="text" class="time-inp">
                    <span>分</span>
                </li>
                <li>
                    <label>天气：</label>
                    <select onchange="weather_Select_onChange()" id="weather_Select">
                        <option value="images/weather1.png">晴</option>
                        <option value="images/weather2.png">多云</option>
                        <option value="images/weather3.png">阴天</option>
                    </select>
                </li>
                <li>
                    <label>温度：</label>
                    <input id="inpt_temperature" onchange="setData()" type="text">
                </li>
                <li>
                    <label>湿度：</label>
                    <input id="inpt_humidity" onchange="setData()" type="text">
                </li>
                <li>
                    <label>背景图片：</label>
                    <select onchange="default_bgImgSelect_onChange()" id="default_bgImgSelect">
                        <option value="images/bg1.png">预设1</option>
                        <option value="images/bg2.png">预设2</option>
                        <option value="images/bg3.png">预设3</option>
                        <option value="images/bg4.png">预设4</option>
                    </select>
                </li>
                <li>
                    <label>自定义背景：</label>
                    <button onclick="inpt_bgimg_onClick()">选择图片</button>
                    <input style="display:none;" type="file" accept="image/*" id="inpt_bgimg" onchange="bgimg_inpt()" />
                    <button onclick="init_bgimg()" class="init-btn">恢复默认</button>
                </li>
                <li>
                    <label>绘制路径：</label>
                    <button onclick="inpt_drawbtn_onClick()">绘制轨迹</button>
                    <input type="checkbox" id="inpt_colorchange_checkbox" onchange="inpt_colorchange_checkbox_onchange()">路径变色</li>
                </li>
                <li>
                    <button onclick="Download()" class="save-btn">保存图片</button>
                </li>
                <li>
                    <div class="warning">
                        <span>
                            <b>免责声明: 页面仅供学习交流，<br />请勿用于其他用途，<br />否则后果作者概不负责！</b>
                        </span>
                    </div>
                    <div class="explanation">
                        <span>1. 修改"数据设置"部分的输入框中的内容即可更改截图中出现的各项数值.</span>
                        <br />
                        <span>2. 点击"保存图片"即可自动生成截图并保存到本地.</span>
                        <br />
                        <br />
                        <span>本项目仓库地址: <a href="https://gitee.com/fyhb/keep">https://gitee.com/fyhb/keep</a>.</span>
                        <br />
                        <span>※本项目魔改自<a href="https://gitee.com/jimaske/njupt-keep">南邮keep跑步打卡截图修改</a>.</span>
                        <br />
                        <span>原作者: 四脚兽起飞(<a href="https://gitee.com/jimaske">@jimaske</a>).</span>
                        <br />
                        <span>由寒冰(<a href="https://gitee.com/fyhb">@fyhb</a>)魔改并发布.</span>
                    </div>
                </li>
            </ul>
            <div id="drawpic_overlay">
                <div class="drawpic_popup">
                    <div><h5>绘制轨迹</h5></div>
                    <div id="drawpic_canvas_wrap">
                        <canvas id="drawpic_canvas" width="1" height="1"></canvas>
                    </div>
                    <div>
                        <button onclick="drawpic_hidebtn_onClick()">取消</button>
                        <button onclick="drawpic_initbtn_onClick()" class="init-btn">重置</button>
                        <button onclick="drawpic_yesbtn_onClick()">确定</button>
                    </div>
                    <canvas id="buffer_canvas" style="display: none;"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script src="./html2canvas.min.js"></script>
    <script type="text/javascript">
        var miles, speeds, username, date_year, date_month, date_day, time_hour, time_min, temperature, humidity;
        var bgSRC = "", ptSRC = "";
        var default_bgSRC = "";
        var use_default_bg = true;

        var canvas, ctx, drawdown, convasData, current_img_width, current_img_height, draw_suofang, buffer_canvas;
        var bs, is_bs, bs_max, bs_range, bs_now, bs_start_x, bs_start_y, bs_end_x, bs_end_y, bs_pres_x, bs_pres_y, bs_pres_color;
        var draw_start_x, draw_start_y, draw_end_x, draw_end_y;

        function fract(num) {
            return num - Math.trunc(num);
        }
        function addZero(i) {
            if (i < 10) {
                i = "0" + String(i);
                return i;
                }
            return String(i);
            }
        
        //将输入框的输入内容存储到对应的变量中
        function setData() {
            username = document.getElementById("inpt_username").value;
		    miles = parseFloat(document.getElementById("inpt_miles").value);
		    speeds = parseFloat(document.getElementById("inpt_speeds").value);
		    date_month = parseInt(document.getElementById("inpt_month").value);
		    date_day = parseInt(document.getElementById("inpt_day").value);
		    time_hour = parseInt(document.getElementById("inpt_hour").value);
		    time_min = parseInt(document.getElementById("inpt_min").value);
		    temperature = parseInt(document.getElementById("inpt_temperature").value);
		    humidity = parseInt(document.getElementById("inpt_humidity").value);
		    rander();
        }

        //初始化输入框, 将变量的内容放到输入框中
        function initInputData() {
            document.getElementById("inpt_username").value = username;
		    document.getElementById("inpt_miles").value = miles;
		    document.getElementById("inpt_speeds").value = speeds;
		    document.getElementById("inpt_month").value = date_month;
		    document.getElementById("inpt_day").value = date_day;
		    document.getElementById("inpt_hour").value = time_hour;
		    document.getElementById("inpt_min").value = time_min;
		    document.getElementById("inpt_temperature").value = temperature;
		    document.getElementById("inpt_humidity").value = humidity;
        }

        //渲染, 将输入的内容放到图片的对应位置
		function rander() {
		    let miles_int = Math.floor(miles);
            let miles_dec = Math.round((miles - miles_int) * 100);
            let speeds_int = Math.floor(speeds);
            let speeds_dec = Math.round((speeds - speeds_int) * 100);
		    let times = (speeds_dec / 60 + speeds_int) * miles;
            let timeInc = Math.trunc(times);
            let cost_hour = Math.floor(timeInc / 60);
            let cost_min = timeInc % 60;
            let cost_sec = Math.round((times - timeInc) * 60);
            let calorie = Math.round(69 * miles * 1.036);
		    document.getElementById("mile-par").innerHTML = miles_int;
		    document.getElementById("mile-poi").innerHTML = addZero(miles_dec);
		    document.getElementById("date").innerHTML = String(date_year) + "/" + addZero(date_month) + "/" + addZero(date_day);
		    document.getElementById("time").innerHTML = addZero(time_hour) + ":" + addZero(time_min);
		    document.getElementById("temperature").innerHTML = String(temperature) + "℃";
		    document.getElementById("humidity").innerHTML = String(humidity) + "%";
		    document.getElementById("username").innerHTML = username;
		    document.getElementById("spe-min").innerHTML = addZero(speeds_int);
		    document.getElementById("spe-sec").innerHTML = addZero(speeds_dec);
		    document.getElementById("cost-hour").innerHTML = addZero(cost_hour);
		    document.getElementById("cost-min").innerHTML = addZero(cost_min);
		    document.getElementById("cost-sec").innerHTML = addZero(cost_sec);
		    document.getElementById("calorie").innerHTML = addZero(calorie);
		}

        //选择预设图片
		function default_bgImgSelect_onChange() {
		    default_bgSRC = document.getElementById("default_bgImgSelect").value;
		    document.getElementById("bg-img").src = document.getElementById("default_bgImgSelect").value;
            document.getElementById("bg-img").onload = function() {
                getNaturalSize();
            }
		}

        //选择天气
		function weather_Select_onChange() {
		    document.getElementById("weather").src = document.getElementById("weather_Select").value;
		}

    	function dataURLtoBlob(dataurl) {
			var arr = dataurl.split(',');
			//注意base64的最后面中括号和引号是不转译的   
			var _arr = arr[1].substring(0, arr[1].length - 2);
			var mime = arr[0].match(/:(.*?);/)[1],
				bstr = atob(_arr),
				n = bstr.length,
				u8arr = new Uint8Array(n);
			while (n--) {
				u8arr[n] = bstr.charCodeAt(n);
			}
			return new Blob([u8arr], {
				type: mime
			});
		}

        //按下更改背景图片的按钮时调用的方法
        function inpt_bgimg_onClick() {
            document.getElementById("inpt_bgimg").click();
        }
        //按下更改头像的按钮时调用的方法
        function inpt_portrait_onClick() {
            document.getElementById("inpt_portrait").click();
        }
        //选择并设置背景图片
        function bgimg_inpt() {
			var oFReader = new FileReader();
			oFReader.onload = function (event) {
				var osrc = event.target.result;
				if (bgSRC) {
					URL.revokeObjectURL(bgSRC);
				}
				bgSRC = URL.createObjectURL(dataURLtoBlob(osrc));
				document.getElementById("bg-img").src = bgSRC;
				let IMG = new Image();
				IMG.src = bgSRC;
				IMG.onload = function(){
                    getNaturalSize();
					if(IMG.width / IMG.height > 0.5010){
						document.getElementById("bg-img").style.height = "718.5px";
						document.getElementById("bg-img").style.width = "auto";
					}else{
						document.getElementById("bg-img").style.height = "auto";
						document.getElementById("bg-img").style.width = "360px";
					}
                    use_default_bg = false;
				}
			}
			var ofile = document.getElementById("inpt_bgimg").files[0];
			oFReader.readAsDataURL(ofile);
		}
        //选择并设置头像
        function portrait_inpt() {
			var oFReader = new FileReader();
			oFReader.onload = function (event) {
				var osrc = event.target.result;
				if (ptSRC) {
					URL.revokeObjectURL(ptSRC)
				}
				ptSRC = URL.createObjectURL(dataURLtoBlob(osrc));
				document.getElementById("portrait").src = ptSRC;
				let IMG = new Image();
				IMG.src = ptSRC;
				IMG.onload = function(){
					if(IMG.width > IMG.height){
						document.getElementById("portrait").style.height = "40px";
						document.getElementById("portrait").style.width = "auto";
					}else{
						document.getElementById("portrait").style.height = "auto";
						document.getElementById("portrait").style.width = "40px";
					}
				}
			}
			var ofile = document.getElementById("inpt_portrait").files[0];
			oFReader.readAsDataURL(ofile);
		}
        //恢复默认背景图片
		function init_bgimg() {
		    document.getElementById("bg-img").style.height = "718.5px";
			document.getElementById("bg-img").style.width = "360px";
			document.getElementById("bg-img").src = default_bgSRC;
            getNaturalSize();
            use_default_bg = true;
		}
        //恢复默认头像
		function init_portrait() {
		    document.getElementById("portrait").style.height = "40px";
			document.getElementById("portrait").style.width = "40px";
			document.getElementById("portrait").src = "images/default_portrait.png";
		}

        /*----- 以下为[绘制自定义轨迹]用到的方法 -----*/
        function inpt_drawbtn_onClick() {
            if(current_img_width / current_img_height > 0.5010) {
                draw_suofang = current_img_height / 500;
                document.getElementById("drawpic_canvas_wrap").innerHTML = '<canvas id="drawpic_canvas" width="' + String(current_img_width) + '" height="' + String(current_img_height) + '" style="width: ' + String(Math.floor(current_img_width * (500 / current_img_height))) + 'px; height: 500px;"></canvas>';
            } else {
                draw_suofang = current_img_width / 250;
                document.getElementById("drawpic_canvas_wrap").innerHTML = '<canvas id="drawpic_canvas" width="' + String(current_img_width) + '" height="' + String(current_img_height) + '" style="width: 250px; height: ' + String(Math.floor(current_img_height * (250 / current_img_width))) + 'px;"></canvas>';
            }
            document.getElementById("drawpic_overlay").style.display = "flex";
            document.getElementById("body").style.overflow = "hidden";
            document.getElementById("body").style.height = "100%";
            document.body.addEventListener('touchmove', self.welcomeShowedListener, false);
            start_draw();
        }
        function inpt_colorchange_checkbox_onchange() {
            bs = document.getElementById("inpt_colorchange_checkbox").checked;
        }
        function start_draw() {
            if (bs) {
                handlePointerDown = (e) => {
                    ctx.beginPath();
                    ctx.lineJoin = "round";
                    ctx.lineCap = "round";
                    ctx.lineWidth = String(Math.floor(5 * draw_suofang));
                    bs_pres_color = new Array(38, 201, 154);
                    if (drawdown == false) {
                        draw_start_x = e.offsetX * draw_suofang;
                        draw_start_y = e.offsetY * draw_suofang;
                        ctx.strokeStyle = "rgb(38, 201, 154)".toString();
                    }
                    drawdown = true;
                    bs_pres_x = e.offsetX * draw_suofang;
                    bs_pres_y = e.offsetY * draw_suofang;
                    ctx.moveTo(e.offsetX * draw_suofang, e.offsetY * draw_suofang);
                }
                handlePointerMove = (e) => {
                    if (drawdown) {
                        if (Math.random() < 0.1 && is_bs == false) {
                            is_bs = true;
                            rg = 2 * Math.random() - 1;
                            if (rg > 0) {
                                bs_max = new Array(Math.floor(193 * rg * rg), Math.floor(-110 * rg * rg), Math.floor(-66 * rg * rg));
                            } else {
                                bs_max = new Array(Math.floor(27 * rg * rg), Math.floor(16 * rg * rg), Math.floor(94 * rg * rg));
                            }
                            bs_range = 5 + Math.floor(15 * Math.random());
                            bs_now = 0;
                        }
                        if (is_bs) {
                            ctx.beginPath();
                            ctx.lineJoin = "round";
                            ctx.lineCap = "round";
                            ctx.lineWidth = String(Math.floor(5 * draw_suofang));
                            ctx.moveTo(bs_pres_x, bs_pres_y);
                            var bs_now_color = new Array(Math.floor(38 + (4 * bs_max[0] * bs_now / bs_range) * (1 - bs_now / bs_range)), Math.floor(201 + (4 * bs_max[1] * bs_now / bs_range) * (1 - bs_now / bs_range)), Math.floor(154 + (4 * bs_max[2] * bs_now / bs_range) * (1 - bs_now / bs_range)))
                            var gradient = ctx.createLinearGradient(bs_pres_x, bs_pres_y, e.offsetX * draw_suofang, e.offsetY * draw_suofang);
                            gradient.addColorStop(0, "rgb(" + String(bs_pres_color[0]) + "," + String(bs_pres_color[1]) + " ," + String(bs_pres_color[2]) + " )");
                            gradient.addColorStop(1, "rgb(" + String(bs_now_color[0]) + "," + String(bs_now_color[1]) + " ," + String(bs_now_color[2]) + " )");
                            ctx.strokeStyle = gradient;
                            ctx.lineTo(e.offsetX * draw_suofang, e.offsetY * draw_suofang);
                            ctx.stroke();
                            bs_pres_color = bs_now_color;
                            bs_now += 1
                            if (bs_now >= bs_range) {
                                is_bs = false;
                                ctx.beginPath();
                                ctx.lineJoin = "round";
                                ctx.lineCap = "round";
                                ctx.lineWidth = String(Math.floor(5 * draw_suofang));
                                ctx.moveTo(bs_pres_x, bs_pres_y);
                                ctx.lineTo(e.offsetX * draw_suofang, e.offsetY * draw_suofang);
                                var gradient = ctx.createLinearGradient(bs_pres_x, bs_pres_y, e.offsetX * draw_suofang, e.offsetY * draw_suofang);
                                gradient.addColorStop(0, "rgb(" + String(bs_pres_color[0]) + "," + String(bs_pres_color[1]) + " ," + String(bs_pres_color[2]) + " )");
                                gradient.addColorStop(1, "rgb(38, 201, 154)");
                                ctx.strokeStyle = gradient;
                                ctx.stroke();
                                bs_pres_color = new Array(38, 201, 154);
                            }
                        } else {
                            ctx.lineTo(e.offsetX * draw_suofang, e.offsetY * draw_suofang);
                            ctx.strokeStyle = "rgb(38, 201, 154)".toString();
                            ctx.stroke();
                        }
                        bs_pres_x = e.offsetX * draw_suofang;
                        bs_pres_y = e.offsetY * draw_suofang;
                    }
                }
                handlePointerUp = (e) => {
                    draw_end_x = e.offsetX * draw_suofang;
                    draw_end_y = e.offsetY * draw_suofang;
                    var startIMG = new Image();
                    var endIMG = new Image();
                    startIMG.src = "images/start.png";
                    endIMG.src = "images/end.png";
                    startIMG.onload = function () {
                        ctx.drawImage(startIMG, Math.floor(draw_start_x - 15 * draw_suofang), Math.floor(draw_start_y - 22 * draw_suofang), Math.floor(30 * draw_suofang), Math.floor(30 * draw_suofang));
                    }
                    endIMG.onload = function () {
                        ctx.drawImage(endIMG, Math.floor(draw_end_x - 15 * draw_suofang), Math.floor(draw_end_y - 22 * draw_suofang), Math.floor(30 * draw_suofang), Math.floor(30 * draw_suofang));
                    }
                    convasData = ctx.getImageData(0, 0, canvas.offsetWidth, canvas.offsetHeight);
                    drawdown = false;
                    restorePointer();
                }
            } else {
                handlePointerDown = (e) => {
                    ctx.beginPath();
                    if (drawdown == false) {
                        draw_start_x = e.offsetX * draw_suofang;
                        draw_start_y = e.offsetY * draw_suofang;
                    }
                    drawdown = true;
                    ctx.moveTo(e.offsetX * draw_suofang, e.offsetY * draw_suofang);
                }
                handlePointerMove = (e) => {
                    console.log(e.offsetX, e.offsetY);
                    if (drawdown) {
                        ctx.lineTo(e.offsetX * draw_suofang, e.offsetY * draw_suofang)
                        ctx.strokeStyle = "rgb(38, 201, 154)".toString();
                        ctx.lineJoin = "round"
                        ctx.lineWidth = String(parseInt(5 * draw_suofang));
                        ctx.stroke();
                    }
                }
                handlePointerUp = (e) => {
                    draw_end_x = e.offsetX * draw_suofang;
                    draw_end_y = e.offsetY * draw_suofang;
                    var startIMG = new Image();
                    var endIMG = new Image();
                    startIMG.src = "images/start.png";
                    endIMG.src = "images/end.png";
                    startIMG.onload = function () {
                        ctx.drawImage(startIMG, parseInt(draw_start_x - 15 * draw_suofang), parseInt(draw_start_y - 22 * draw_suofang), parseInt(30 * draw_suofang), parseInt(30 * draw_suofang));
                    }
                    endIMG.onload = function () {
                        ctx.drawImage(endIMG, parseInt(draw_end_x - 15 * draw_suofang), parseInt(draw_end_y - 22 * draw_suofang), parseInt(30 * draw_suofang), parseInt(30 * draw_suofang));
                    }
                    convasData = ctx.getImageData(0, 0, canvas.offsetWidth, canvas.offsetHeight);
                    drawdown = false;
                    restorePointer();
                }
            }
            canvas = document.getElementById('drawpic_canvas');
            ctx = canvas.getContext('2d');
            if (use_default_bg) {
                var bgIMG = new Image();
                bgIMG.src = "images/empty_bg.png";
                bgIMG.onload = function () {
                    ctx.drawImage(bgIMG, 0, 0, current_img_width, current_img_height);
                    drawdown = false;
                    is_bs = false;
                    convasData = null;
                    canvas.addEventListener('pointerdown', handlePointerDown);
                    canvas.addEventListener('pointermove', handlePointerMove);
                    canvas.addEventListener('pointerup', handlePointerUp);
                }
            } else {
                var bgIMG = document.getElementById("bg-img");
                buffer_canvas = document.getElementById("buffer_canvas");
                buffer_ctx = buffer_canvas.getContext('2d');
                buffer_canvas.width = current_img_width;
                buffer_canvas.height = current_img_height;
                buffer_ctx.drawImage(bgIMG, 0, 0, current_img_width, current_img_height);
                buffer_imgdata = buffer_ctx.getImageData(0, 0, current_img_width, current_img_height);
                var cImage = ctx.createImageData(current_img_width, current_img_height);
                for (var i = 0; i < buffer_imgdata.data.length; i += 4) {
                    cImage.data[i + 0] = buffer_imgdata.data[i + 0];
                    cImage.data[i + 1] = buffer_imgdata.data[i + 1];
                    cImage.data[i + 2] = buffer_imgdata.data[i + 2];
                    cImage.data[i + 3] = buffer_imgdata.data[i + 3];
                }
                ctx.putImageData(cImage, 0, 0, 0, 0, current_img_width, current_img_height);
                drawdown = false;
                is_bs = false;
                convasData = null;
                canvas.addEventListener('pointerdown', handlePointerDown);
                canvas.addEventListener('pointermove', handlePointerMove);
                canvas.addEventListener('pointerup', handlePointerUp);
            }
        }
        //这三个方法的具体内容, 取决于是否处在"路径变色"模式
        //所以这里先占个位
        var handlePointerDown, handlePointerMove, handlePointerUp;
        
        function restorePointer() {
            canvas.removeEventListener('pointerdown', handlePointerDown);
            canvas.removeEventListener('pointermove', handlePointerMove);
            canvas.removeEventListener('pointerup', handlePointerUp);
        }
        //取消按钮
		function drawpic_hidebtn_onClick() {
            restorePointer();
            document.getElementById("body").style.overflow = "";
            document.getElementById("body").style.height = "";
            document.body.removeEventListener('touchmove', this.welcomeShowedListener, false);
			document.getElementById("drawpic_overlay").style.display = "none";
		}
        //重置按钮
		function drawpic_initbtn_onClick() {
            ctx.clearRect(0, 0, current_img_width, current_img_height);
            start_draw();
		}
        //确定按钮
		function drawpic_yesbtn_onClick() {
            document.getElementById("body").style.overflow = "";
            document.getElementById("body").style.height = "";
            document.body.removeEventListener('touchmove', this.welcomeShowedListener, false);
            document.getElementById("bg-img").src = canvas.toDataURL();
			document.getElementById("drawpic_overlay").style.display = "none";
		}
        //获取当前使用的背景图片的尺寸
        function getNaturalSize () {
            img = document.getElementById("bg-img")
            current_img_width = img.naturalWidth;
            current_img_height = img.naturalHeight;
        }
        /*----- 以上为[绘制自定义轨迹]用到的方法 -----*/

        //下载截图
		function Download() {
		    let ele = document.getElementById("new-Img");
            html2canvas(ele, {
                useCORS: true,
                logging: false,
            }).then((canvas) => {
                let dataurl = canvas.toDataURL('image/png');
                let donwLink = document.createElement('a');
                donwLink.href = dataurl;
                donwLink.download = "keep" + (date_month) + "月" + (date_day) + "日" + "跑步打卡"; // 图片名字
                donwLink.click();
                // let event = new MouseEvent('click');
                // donwLink.dispatchEvent(event);
            });
		}
        //页面加载出来后, 先初始化变量
        window.onload = function() {
            document.getElementById("bg-img").src = document.getElementById("default_bgImgSelect").value;
            default_bgSRC = document.getElementById("default_bgImgSelect").value;
            document.getElementById("bg-img").onload = function() {
                getNaturalSize();
            }
            document.getElementById("weather").src = document.getElementById("weather_Select").value;
            bs = document.getElementById("inpt_colorchange_checkbox").checked
            miles = Math.floor((2 + Math.random() * 3) * 100) / 100;
            speeds = Math.floor((4 + Math.random() * 6) * 100) / 100;
            let datetime_now = new Date();
            date_year = datetime_now.getFullYear();
            date_month = datetime_now.getMonth();
            date_day = datetime_now.getDate();
            time_hour = datetime_now.getHours();
            time_min = datetime_now.getMinutes();
            username = "UserName";
            humidity = 69;
            temperature = 21;
            initInputData();
            rander();
        }
    </script>
</body>
</html>