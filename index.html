<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4C56GQP4ZL');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <title>HEU Keep Generator</title>
    <link rel="icon" href="./favicon.ico">
    <link rel="shortcut icon" href="./favicon.ico">
    <link rel="stylesheet" href="./css/liquid.css">
        <link rel="preload" href="./DINCond-Bold.otf" as="font" type="font/otf" crossorigin>
            <style>
                /* =========================================
                   iOS ç§»åŠ¨ç«¯å¸ƒå±€ä¸“é¡¹ä¿®å¤ (Ver 2.0)
                   ========================================= */

                /* 1. æ ·å¼é€‰æ‹©æ¡†ä¿®å¤ */
                .flex-group select {
                    flex: 0 1 auto !important;
                    width: fit-content !important;
                    min-width: 60px;
                    max-width: 65%; /* ç¨å¾®ç»™å¤§ä¸€ç‚¹ç‚¹ */
                    padding-right: 25px !important;
                }
                
                .flex-group button {
                    flex-shrink: 0 !important;
                    white-space: nowrap;
                }

                /* 2. æ ‡é¢˜è¾“å…¥æ¡†ä¿®å¤ */
                .input-with-prefix {
                    display: inline-flex !important;
                    width: auto !important;
                    flex-wrap: nowrap !important;
                    /* ç§»é™¤ max-width é™åˆ¶ï¼Œå…è®¸å®ƒæ’‘å¼€ï¼Œçˆ¶çº§é€šå¸¸ä¼šè‡ªåŠ¨å¤„ç†æº¢å‡º */
                }
                /* =========================================
                   3. æ—¶é—´/æ—¥æœŸå°è¾“å…¥æ¡†ä¸“é¡¹ä¿®å¤
                   ========================================= */
                /* é’ˆå¯¹ å¹´/æœˆ/æ—¥/æ—¶/åˆ†/æ¸©æ¹¿åº¦ çš„å¾®å‹è¾“å…¥æ¡† */
                .time-inp, .year-inp, .date-inp, .mini-input, #inpt_temperature, #inpt_humidity {
                    padding: 0 2px !important;   /* æå°çš„å†…è¾¹è· */
                    min-width: 25px !important;  /* å…è®¸ç¼©å¾—éå¸¸å° */
                    text-align: center !important; /* æ–‡å­—å±…ä¸­ */
                    width: auto;
                }

                /* ç¨å¾®ç»™å¹´ä»½å®½ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ˜¯4ä½æ•° */
                .year-inp {
                    min-width: 40px !important;
                }
                /* =========================================
                       4. æè‡´ç´§å‡‘å¸ƒå±€ä¿®å¤ (ç¼©å‡æ ‡ç­¾ç©ºéš™)
                       ========================================= */
                    
                    /* 1. é’ˆå¯¹æ¯ä¸€è¡Œçš„å®¹å™¨ï¼šå‡å° Flex é—´è· */
                    .setDataList li {
                        gap: 4px !important;          /* åŸæœ¬å¯èƒ½æ˜¯ 10px æˆ– 15pxï¼Œç°åœ¨æ”¹ä¸º 4px */
                        justify-content: flex-start;  /* å¼ºåˆ¶å†…å®¹é å·¦ï¼Œä¸åˆ†æ•£å¯¹é½ */
                    }

                    /* 2. é’ˆå¯¹æ ‡ç­¾ (Label)ï¼šå–æ¶ˆå›ºå®šå®½åº¦ï¼Œæ”¹ä¸ºâ€œæ–‡å­—å¤šå®½å°±å¤šå®½â€ */
                    .setDataList li label {
                        min-width: 0 !important;      /* æ ¸å¿ƒï¼šå–æ¶ˆ 80px çš„å¼ºåˆ¶å ä½ */
                        width: auto !important;       /* æ ¸å¿ƒï¼šå®½åº¦ç”±æ–‡å­—å†…å®¹å†³å®š */
                        flex: 0 0 auto !important;    /* ç¦æ­¢è¢«å‹ç¼©æˆ–æ‹‰ä¼¸ */
                        margin-right: 2px !important; /* æ ‡ç­¾å’Œè¾“å…¥æ¡†ä¹‹é—´åªç•™ 2px ç¼éš™ */
                        text-align: right;            /* (å¯é€‰) æ–‡å­—é å³å¯¹é½ */
                    }

                    /* 3. é’ˆå¯¹å¸¦å‰ç¼€çš„æ¡† (keep â€¢ æˆ·å¤–è·‘æ­¥) */
                    .input-with-prefix {
                        gap: 2px !important;          /* ç¼©å‡ "keep â€¢" å’Œè¾“å…¥æ¡†ä¹‹é—´çš„è·ç¦» */
                    }
                    
                    /* å¾®è°ƒå‰ç¼€æ–‡å­—çš„è¾¹è· */
                    .prefix {
                        margin-right: 0 !important;
                        padding-right: 2px !important;
                    }
                /* =========================================
                       5. å¼ºåˆ¶é‡Œç¨‹ä¸é…é€Ÿè¾“å…¥æ¡†æ–‡å­—å±…ä¸­
                       ========================================= */
                    
                    /* é’ˆå¯¹ é‡Œç¨‹(#inpt_miles) å’Œ é…é€Ÿ(#inpt_speeds) ä¸»è¾“å…¥æ¡† */
                    #inpt_miles,
                    #inpt_speeds,
                    #inpt_savePic_width,
                    .mile2-inp {
                        text-align: center !important; /* å¼ºåˆ¶è¦†ç›–é»˜è®¤çš„å·¦å¯¹é½ */
                        padding: 0 5px !important;     /* ç¨å¾®ä¿®æ­£å†…è¾¹è· */
                    }

                    /* (å¯é€‰) å¦‚æœä¸‹é¢çš„éšæœºèŒƒå›´å°æ¡†ä¹Ÿæ²¡å±…ä¸­ï¼ŒåŠ ä¸Šè¿™ä¸ª */
                    .range-input {
                        text-align: center !important;
                    }

                .input-with-prefix input {
                    /* æ ¸å¿ƒï¼šç¦æ­¢è¢« Flex å¸ƒå±€æŒ¤å‹ */
                    flex-shrink: 0 !important;
                    flex-grow: 0 !important;
                    
                    /* æ ¸å¿ƒï¼šå…è®¸æ ¹æ® JS è®¾ç½®çš„ width ç”Ÿæ•ˆ */
                    width: auto;
                    
                    /* ä¿åº•å®½åº¦ï¼Œé˜²æ­¢è¿˜æ²¡åŠ è½½å‡ºæ¥æ—¶å¤ªä¸‘ */
                    min-width: 80px !important;
                }
            </style>
</head>

<body id="body">

    <!-- åŠ¨æ€èƒŒæ™¯å±‚ -->
    <div class="liquid-bg-gradient"></div>
    <div class="liquid-orb orb-1"></div>
    <div class="liquid-orb orb-2"></div>

    <div id="main-div">
        <!-- å·¦ä¾§ï¼šæ‰‹æœºé¢„è§ˆ (è¢«å…‹éš†çš„ç›®æ ‡) -->
        <div id="new-Img" class="new-img glass-effect">
            <div class="bgimgwrap" id="bgimgwrap">
                <img src="" class="innerbgimg" id="bg-img" alt="" />
            </div>
            <!-- è¿™é‡Œçš„ gui-img å¯èƒ½æ˜¯ canvas ç»˜å›¾ï¼Œå…‹éš†æ—¶éœ€è¦ç‰¹æ®Šå¤„ç† -->
            <img src="" id="gui-img" alt="" />
            
            <div class="portrait-wrap" id="portrait-wrap">
                <img class="portrait" id="portrait" src="" alt="" />
            </div>
            <div class="weather-imgwrap">
                <img src="" class="weather" id="weather" alt="" />
            </div>
            <span class="username" id="username">UserName</span>
            <span class="keep-title" id="keep-title">æˆ·å¤–è·‘æ­¥</span>
            <span class="mile"><span id="mile" class="mile-data">0.00</span><span class="gongli">å…¬é‡Œ</span></span>
            <span class="datetime date" id="date">0000/00/00</span>
            <span class="datetime time" id="time">00:00</span>
            <span class="env temperature" id="temperature">00</span>
            <span class="env humidity" id="humidity">00</span>
            <span class="speed-time speed" id="speed">00'00"</span>
            <span class="speed-time cost-time" id="cost-time">00:00:00</span>
            <span class="speed-time calorie" id="calorie">0</span>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="set-data">
            <div id="messageBox"></div>

            <!-- å¯¼å‡ºæ§åˆ¶åŒº -->
            <div class="glass-card export-panel">
                <div class="export-grid">
                    <!-- è¿™é‡Œçš„ Download1 æ˜¯å¤–éƒ¨JSå®šä¹‰çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¼šå…¼å®¹å®ƒ -->
                    <button onclick="Download(Download1)" class="btn-primary main-save">
                        <span class="icon"></span> ä¿å­˜é«˜æ¸…å›¾ç‰‡
                    </button>
                    <!-- é¢„è§ˆç­‰æŒ‰é’®ä¿ç•™åŸæœ‰é€»è¾‘ -->
                    <button onclick="Download(Download2)" class="btn-secondary main-preview">
                        <span class="icon"></span> é¢„è§ˆ
                    </button>
                    <button onclick="Download(Download3)" class="btn-tiny backup-btn">å¤‡ç”¨æ–¹æ¡ˆ A</button>
                </div>
            </div>

            <!-- ä¸»è®¾ç½®é¢æ¿ -->
            <div class="glass-card control-panel">
                <ul class="setDataList">
                    <!-- ç”¨æˆ·ä¿¡æ¯ -->
                    <div class="input-group">
                        <div class="group-title">åŸºæœ¬ä¿¡æ¯</div>
                        <li>
                            <label>ç”¨æˆ·å</label>
                            <input id="inpt_username" onchange="setData()" type="text" placeholder="è¾“å…¥æ˜µç§°">
                        </li>
                        <li>
                            <label>å¤´åƒ</label>
                            <div class="file-action-row">
                                <button onclick="inpt_portrait_onClick()" class="btn-small">ä¸Šä¼ </button>
                                <button onclick="init_portrait()" class="btn-text">æ¢å¤é»˜è®¤</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_portrait" onchange="portrait_inpt()" />
                            </div>
                        </li>
                        <li>
                            <label>æ ‡é¢˜</label>
                            <div class="input-with-prefix">
                                <span class="prefix">keep â€¢ </span>
                                <input id="inpt_keep_title" onchange="setData()" type="text" placeholder="æˆ·å¤–è·‘æ­¥">
                            </div>
                        </li>
                    </div>

                    <!-- è¿åŠ¨æ•°æ® -->
                    <div class="input-group">
                        <div class="group-title">è¿åŠ¨æ•°æ®</div>
                        <li>
                            <label>é‡Œç¨‹</label>
                            <input id="inpt_miles" onchange="setData()" type="text" class="font-mono" placeholder="0.00">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">éšæœºèŒƒå›´:</span>
                            <input type="text" id="min_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Min">
                            <span class="dash">-</span>
                            <input type="text" id="max_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Max">
                        </div>

                        <li style="margin-top: 12px;">
                            <label>é…é€Ÿ</label>
                            <input id="inpt_speeds" onchange="setData()" type="text" class="font-mono" placeholder="5'30&quot;">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">éšæœºèŒƒå›´:</span>
                            <input type="text" id="min_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="å¿«">
                            <span class="dash">-</span>
                            <input type="text" id="max_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="æ…¢">
                        </div>
                    </div>

                    <!-- æ—¶é—´ä¸ç¯å¢ƒ -->
                    <div class="input-group">
                        <div class="group-title">æ—¶é—´ä¸ç¯å¢ƒ</div>
                        <li>
                            <label>æ—¶é—´</label>
                            <div class="datetime-row">
                                <input id="inpt_year" onchange="setData()" type="text" class="year-inp"><span>/</span>
                                <input id="inpt_month" onchange="setData()" type="text" class="date-inp"><span>/</span>
                                <input id="inpt_day" onchange="setData()" type="text" class="date-inp">
                                <span class="spacer"></span>
                                <input id="inpt_hour" onchange="setData()" type="text" class="time-inp"><span>:</span>
                                <input id="inpt_min" onchange="setData()" type="text" class="time-inp">
                            </div>
                        </li>
                        <li>
                            <label>å¤©æ°”</label>
                            <select onchange="weather_Select_onChange()" id="weather_Select">
                                <option value="images/weather1.png">æ™´</option>
                                <option value="images/weather2.png">å¤šäº‘</option>
                                <option value="images/weather3.png">é˜´å¤©</option>
                            </select>
                        </li>
                        <li>
                            <label>æ¸©æ¹¿åº¦</label>
                            <div class="dual-input">
                                <input id="inpt_temperature" onchange="setData()" type="text" class="mini-input" placeholder="Â°C">
                                <span class="unit">Â°C</span>
                                <input id="inpt_humidity" onchange="setData()" type="text" class="mini-input" placeholder="%">
                                <span class="unit"></span>
                            </div>
                        </li>
                    </div>

                    <!-- åœ°å›¾ä¸è½¨è¿¹ -->
                    <div class="input-group">
                        <div class="group-title">åœ°å›¾ä¸è½¨è¿¹</div>
                        <li>
                            <label>èƒŒæ™¯</label>
                            <select onchange="default_bgImgSelect_onChange()" id="default_bgImgSelect">
                                <option value="guiji_Select_1">å—ä½“è‚²åœº</option>
                                <option value="guiji_Select_2">å†›å·¥æ“åœº</option>
                                <option value="guiji_Select_3">åŒ—ä½“è‚²åœº</option>
                            </select>
                        </li>
                        <li>
                            <label>è‡ªå®šä¹‰</label>
                            <div class="file-action-row">
                                <button onclick="inpt_bgimg_onClick()" class="btn-small">ä¸Šä¼ åœ°å›¾</button>
                                <button onclick="init_bgimg()" class="btn-text">é‡ç½®</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_bgimg" onchange="bgimg_inpt()" />
                            </div>
                        </li>

                        <li>
                            <label>æ ·å¼</label>
                            <div class="flex-group" style="display:flex; gap:8px; align-items:center; flex:1;">
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_1" class="guijiSelect">
                                    <option value="['images/bg1_1.png', 'images/bg1_empty2.png']">æ ·å¼ 1</option>
                                    <option value="['images/bg1_2.png', 'images/bg1_empty2.png']">æ ·å¼ 2</option>
                                    <option value="['images/bg1_3.png', 'images/bg1_empty2.png']">æ ·å¼ 3</option>
                                    <option value="['images/bg1_4.png', 'images/bg1_empty2.png']">æ ·å¼ 4</option>
                                    <option value="['images/bg1_5.png', 'images/bg1_empty2.png']">æ ·å¼ 5</option>
                                    <option value="['images/bg1_empty2.png', 'images/bg1_empty2.png']">é»˜è®¤</option>
                                </select>
                                <button onclick="drawMine()" class="btn-small btn-secondary" title="ç”Ÿæˆéšæœºè·¯å¾„">éšæœº</button>
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_2" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg2_empty.png', 'images/bg2_empty.png']">é»˜è®¤</option>
                                </select>
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_3" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg3_empty.png', 'images/bg3_empty.png']">é»˜è®¤</option>
                                </select>
                            </div>
                        </li>

                        <li class="switch-row">
                            <div class="switch-item">
                                <input type="checkbox" id="auto_draw_checkbox" onchange="auto_draw_checkbox_onchange()" checked />
                                <span>è‡ªåŠ¨ç”Ÿæˆ</span>
                            </div>
                            <div class="switch-item">
                                <input type="checkbox" id="inpt_colorchange_checkbox" onchange="inpt_colorchange_checkbox_onchange()" checked />
                                <span>æ¸å˜è‰²</span>
                            </div>
                        </li>
                        <div class="sub-setting" id="bs_prop_inpt_wrap">
                            <span class="sub-label">å˜è‰²æ¦‚ç‡:</span>
                            <input id="inpt_bs_prob" onchange="setData()" type="text" class="mini-input" placeholder="0.5">
                        </div>
                        <div class="sub-setting" id="inpt_bs_range_wrap">
                            <span class="sub-label">å˜è‰²æ­¥é•¿:</span>
                            <input id="inpt_bs_range_min" onchange="setData()" type="text" class="mini-input">
                            <span class="dash">-</span>
                            <input id="inpt_bs_range_max" onchange="setData()" type="text" class="mini-input">
                        </div>
                    </div>

                    <!-- è¾“å‡ºå°ºå¯¸ -->
                    <div class="input-group no-border">
                        <li>
                            <label>å®½åº¦</label>
                            <input id="inpt_savePic_width" onchange="setData()" type="text" placeholder="é»˜è®¤" style="min-width:50px;">
                            <span class="unit">px</span>
                        </li>
                    </div>

                </ul>

                <div class="divider"></div>
                <div class="system-actions">
                    <button onclick="storeToIndexedDB(tmp_portrait_src,tmp_bgimg_osrc)" class="btn-text">ä¿å­˜é…ç½®</button>
                    <button onclick="clearIndexedDB()" class="btn-text btn-danger-text">é‡ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS å¼•ç”¨ -->
    <script src="js/invoke/html2canvas.min.js" defer></script>
    <script src="js/invoke/amapHelper.js" defer></script>
    <script src="js/indexedDB.js" defer></script>
    <script src="js/init.js" defer></script>
    <script src="js/render.js" defer></script>
    <script src="js/select_manner.js" defer></script>
    <script src="js/dataURLtoBlob.js" defer></script>
    <script src="js/img_both_inpt_set.js" defer></script>
    <script src="js/draw_personalization.js" defer></script>
    <!-- æ³¨æ„ï¼šdownload_img.js é‡Œçš„å‡½æ•°ä¼šè¢«ä¸‹é¢çš„è„šæœ¬è¦†ç›–ï¼Œè¿™æ˜¯æ­£å¸¸çš„ -->
    <script src="js/download_img.js" defer></script>
    <script src="js/localTrackGen.js"></script>
    <script src="js/drawMine.js" defer></script>
    <script src="js/onload.js" defer></script>
    <!-- âœ… æ€§èƒ½ä¼˜åŒ–ç‰ˆï¼šiOS è¾“å…¥æ¡†è‡ªé€‚åº”å®½åº¦è„šæœ¬ -->
        <script>
            // 1. Canvas ä¸Šä¸‹æ–‡å•ä¾‹ (é¿å…é‡å¤åˆ›å»ºå¯¹è±¡)
            const measureCtx = (function() {
                const canvas = document.createElement("canvas");
                return canvas.getContext("2d");
            })();

            // ç¼“å­˜è®¡ç®—å‡ºçš„å­—ä½“å­—ç¬¦ä¸²ï¼Œé¿å…é‡å¤è¯»å– DOM (å¯é€‰ä¼˜åŒ–ï¼Œè§†æƒ…å†µè€Œå®šï¼Œè¿™é‡Œä¸ºäº†å‡†ç¡®æ€§æ¯æ¬¡è¯»å–)
            function getCanvasFont(elem) {
                const style = window.getComputedStyle(elem);
                // ç®€åŒ–è·å–é€»è¾‘
                return `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;
            }

            // 2. æ ¸å¿ƒå®½åº¦è®¡ç®— (æ—  DOM å†™å…¥ï¼Œçº¯è®¡ç®—)
            function calculateWidth(elem) {
                measureCtx.font = getCanvasFont(elem);
                // ä¼˜å…ˆå– value -> placeholder -> ç©ºä¸²
                const text = elem.value || elem.placeholder || "";
                const metrics = measureCtx.measureText(text);
                
                // æ™ºèƒ½ç•™ç™½é€»è¾‘
                const isMini = elem.classList.contains('time-inp') ||
                               elem.classList.contains('year-inp') ||
                               elem.classList.contains('date-inp') ||
                               elem.classList.contains('mini-input') ||
                               elem.id === 'inpt_temperature' ||
                               elem.id === 'inpt_humidity';

                const extraSpace = isMini ? 15 : 35;
                return Math.ceil(metrics.width) + extraSpace;
            }

            // 3. é«˜æ€§èƒ½æ›´æ–°é˜Ÿåˆ— (ä½¿ç”¨ rAF é¿å…æ‰å¸§)
            let updateQueue = new Set();
            let isTicking = false;

            function requestUpdate(elem) {
                updateQueue.add(elem);
                if (!isTicking) {
                    requestAnimationFrame(flushQueue);
                    isTicking = true;
                }
            }

            function flushQueue() {
                updateQueue.forEach(elem => {
                    const newWidth = calculateWidth(elem);
                    // åªæœ‰å®½åº¦çœŸæ­£å˜åŒ–æ—¶æ‰å†™å…¥ DOM
                    if (elem.style.width !== `${newWidth}px`) {
                        elem.style.width = `${newWidth}px`;
                    }
                });
                updateQueue.clear();
                isTicking = false;
            }

            // 4. åˆå§‹åŒ–ä¸äº‹ä»¶å§”æ‰˜ (æå¤§çš„å†…å­˜ä¼˜åŒ–)
            function initAutoWidth() {
                // ç«‹å³è®¡ç®—ä¸€æ¬¡æ‰€æœ‰æ¡†
                document.querySelectorAll('input[type="text"]').forEach(requestUpdate);

                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œåªåœ¨çˆ¶å®¹å™¨ .set-data ä¸Šç›‘å¬
                const container = document.querySelector('.set-data');
                if (!container) return;

                container.addEventListener('input', (e) => {
                    if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
                        requestUpdate(e.target);
                    }
                });
                
                // blur äº‹ä»¶ä¸å†’æ³¡ï¼Œfocusout å†’æ³¡
                container.addEventListener('focusout', (e) => {
                    if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
                        requestUpdate(e.target);
                    }
                });
            }

            // 5. API èµ‹å€¼åŠ«æŒ (ä¿æŒä¸å˜ï¼Œä½†æ¥å…¥ rAF ç³»ç»Ÿ)
            function fixWeatherApiWidth() {
                const targetIds = ['inpt_temperature', 'inpt_humidity', 'inpt_keep_title', 'inpt_username', 'inpt_year', 'inpt_month', 'inpt_day', 'inpt_hour', 'inpt_min'];
                targetIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        const descriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');
                        Object.defineProperty(el, 'value', {
                            get: function() { return descriptor.get.call(this); },
                            set: function(v) {
                                descriptor.set.call(this, v);
                                requestUpdate(this); // æ¥å…¥é«˜æ€§èƒ½æ›´æ–°é˜Ÿåˆ—
                            }
                        });
                    }
                });
            }

            window.addEventListener('DOMContentLoaded', function() {
                fixWeatherApiWidth();
                initAutoWidth();

                // ç»ˆæå»¶è¿Ÿæ£€æŸ¥
                document.fonts.ready.then(() => {
                    setTimeout(() => {
                        document.querySelectorAll('input[type="text"]').forEach(requestUpdate);
                        console.log("ğŸš€ High-perf width adjustment ready.");
                    }, 500);
                });
            });
        </script>
    <!-- ğŸŒŸ ç»ˆæä¿®å¤ï¼šç¦»å±å…‹éš†ç”Ÿæˆå™¨ -->
    <script>
        window.addEventListener('load', function() {
            console.log("Liquid Fix: Off-screen renderer loaded.");

            // è¦†ç›–åŸæœ‰çš„ Download å‡½æ•°
            window.Download = function(fileNameArg) {
                const targetNode = document.getElementById('new-Img');
                if (!targetNode) return;

                // 1. åˆ›å»ºå¹½çµå®¹å™¨ (Ghost Container)
                // è¿™ä¸ªå®¹å™¨ä½äºå±å¹•å¤–ï¼Œç”¨äºæ”¾ç½®æˆ‘ä»¬çš„å…‹éš†ä½“
                const ghostWrapper = document.createElement('div');
                ghostWrapper.style.position = 'fixed';
                ghostWrapper.style.top = '-9999px';
                ghostWrapper.style.left = '-9999px';
                ghostWrapper.style.zIndex = '-1000';
                // é”å®šå®½åº¦ï¼Œé˜²æ­¢å› å®¹å™¨å˜åŒ–å¯¼è‡´å†…å®¹æ¢è¡Œ
                ghostWrapper.style.width = targetNode.offsetWidth + 'px';
                document.body.appendChild(ghostWrapper);

                // 2. æ·±åº¦å…‹éš†èŠ‚ç‚¹
                const clonedNode = targetNode.cloneNode(true);

                // 3. å…³é”®ï¼šæ‰‹åŠ¨é‡ç»˜ Canvas å†…å®¹
                // cloneNode ä¸ä¼šå¤åˆ¶ canvas çš„ç»˜å›¾çŠ¶æ€ï¼Œå¿…é¡»æ‰‹åŠ¨æŠŠåŸå›¾ç”»è¿‡å»
                const originalCanvases = targetNode.querySelectorAll('canvas');
                const clonedCanvases = clonedNode.querySelectorAll('canvas');
                originalCanvases.forEach((orig, index) => {
                    if (clonedCanvases[index]) {
                        const destCtx = clonedCanvases[index].getContext('2d');
                        // ç¡®ä¿å°ºå¯¸ä¸€è‡´
                        clonedCanvases[index].width = orig.width;
                        clonedCanvases[index].height = orig.height;
                        destCtx.drawImage(orig, 0, 0);
                    }
                });

                // 4. å‡€åŒ–å…‹éš†ä½“æ ·å¼
                // è¿™é‡Œç§»é™¤æ‰€æœ‰å¯¼è‡´ html2canvas å´©æºƒçš„ç‰¹æ•ˆ
                clonedNode.style.transform = 'none';       // ç§»é™¤ç¼©æ”¾
                clonedNode.style.boxShadow = 'none';       // ç§»é™¤é˜´å½±
                clonedNode.style.margin = '0';             // ç§»é™¤è¾¹è·
                clonedNode.style.transition = 'none';      // ç§»é™¤åŠ¨ç”»
                
                // ç¡®ä¿èƒŒæ™¯æ­£ç¡® (é˜²æ­¢èƒŒæ™¯é€æ˜å˜é»‘)
                if (getComputedStyle(targetNode).backgroundColor === 'rgba(0, 0, 0, 0)') {
                   // å¦‚æœåŸèƒŒæ™¯é€æ˜ï¼Œä¿æŒé€æ˜æˆ–è®¾ä¸ºç™½è‰²ï¼Œè§†éœ€æ±‚è€Œå®š
                }

                ghostWrapper.appendChild(clonedNode);

                // 5. ç¡®å®šæ–‡ä»¶å
                let fileName = "HEU_Run_" + new Date().toISOString().slice(0,10) + ".png";
                // å…¼å®¹åŸä»£ç ä¼ å…¥çš„ Download1 å‡½æ•°æˆ–å­—ç¬¦ä¸²
                if (typeof fileNameArg === 'function') {
                    try { fileName = fileNameArg(); } catch (e) {}
                } else if (typeof fileNameArg === 'string') {
                    fileName = fileNameArg;
                }
                // ç¡®ä¿åç¼€å
                if (!fileName.endsWith('.png')) fileName += '.png';

                // 6. è°ƒç”¨ html2canvas
                // å› ä¸ºå…‹éš†ä½“æ²¡æœ‰ç‰¹æ•ˆï¼Œè¿™é‡Œæ¸²æŸ“ä¼šéå¸¸å¿«ä¸”å‡†ç¡®
                html2canvas(clonedNode, {
                    scale: 2,          // 2å€é«˜æ¸…
                    useCORS: true,     // è·¨åŸŸæ”¯æŒ
                    backgroundColor: null, // ä¿æŒé€æ˜èƒŒæ™¯
                    logging: false
                }).then(canvas => {
                    // 7. è§¦å‘ä¸‹è½½
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 8. æ¸…ç†
                    document.body.removeChild(ghostWrapper);
                    console.log("Download success.");
                }).catch(err => {
                    console.error("ç”Ÿæˆå¤±è´¥:", err);
                    alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å›¾ç‰‡è·¨åŸŸè®¾ç½®");
                    if (document.body.contains(ghostWrapper)) {
                        document.body.removeChild(ghostWrapper);
                    }
                });
            };
        });
    </script>
</body>
</html>
