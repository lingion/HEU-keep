<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4C56GQP4ZL');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <title>HEU‰∫∫ÊúÄÂêéÁöÑÂÄîÂº∫ ver.Liquid</title>
    <link rel="icon" href="./favicon.ico">
    <link rel="shortcut icon" href="./favicon.ico">
    <link rel="stylesheet" href="./css/liquid.css">
    <link rel="preload" href="./DINCond-Bold.otf" as="font" type="font/otf" crossorigin>
</head>

<body id="body">

    <!-- Âä®ÊÄÅËÉåÊôØÂ±Ç -->
    <div class="liquid-bg-gradient"></div>
    <div class="liquid-orb orb-1"></div>
    <div class="liquid-orb orb-2"></div>

    <div id="main-div">
        <!-- Â∑¶‰æßÔºöÊâãÊú∫È¢ÑËßà (Ë¢´ÂÖãÈöÜÁöÑÁõÆÊ†á) -->
        <div id="new-Img" class="new-img glass-effect">
            <div class="bgimgwrap" id="bgimgwrap">
                <img src="" class="innerbgimg" id="bg-img" alt="" />
            </div>
            <!-- ËøôÈáåÁöÑ gui-img ÂèØËÉΩÊòØ canvas ÁªòÂõæÔºåÂÖãÈöÜÊó∂ÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ -->
            <img src="" id="gui-img" alt="" />
            
            <div class="portrait-wrap" id="portrait-wrap">
                <img class="portrait" id="portrait" src="" alt="" />
            </div>
            <div class="weather-imgwrap">
                <img src="" class="weather" id="weather" alt="" />
            </div>
            <span class="username" id="username">UserName</span>
            <span class="keep-title" id="keep-title">Êà∑Â§ñË∑ëÊ≠•</span>
            <span class="mile"><span id="mile" class="mile-data">0.00</span><span class="gongli">ÂÖ¨Èáå</span></span>
            <span class="datetime date" id="date">0000/00/00</span>
            <span class="datetime time" id="time">00:00</span>
            <span class="env temperature" id="temperature">00</span>
            <span class="env humidity" id="humidity">00</span>
            <span class="speed-time speed" id="speed">00'00"</span>
            <span class="speed-time cost-time" id="cost-time">00:00:00</span>
            <span class="speed-time calorie" id="calorie">0</span>
        </div>

        <!-- Âè≥‰æßÔºöÊéßÂà∂Èù¢Êùø -->
        <div class="set-data">
            <div id="messageBox"></div>

            <!-- ÂØºÂá∫ÊéßÂà∂Âå∫ -->
            <div class="glass-card export-panel">
                <div class="export-grid">
                    <!-- ËøôÈáåÁöÑ Download1 ÊòØÂ§ñÈÉ®JSÂÆö‰πâÁöÑÂáΩÊï∞ÔºåÊàë‰ª¨‰ºöÂÖºÂÆπÂÆÉ -->
                    <button onclick="Download(Download1)" class="btn-primary main-save">
                        <span class="icon"></span> ‰øùÂ≠òÈ´òÊ∏ÖÂõæÁâá
                    </button>
                    <!-- È¢ÑËßàÁ≠âÊåâÈíÆ‰øùÁïôÂéüÊúâÈÄªËæë -->
                    <button onclick="Download(Download2)" class="btn-secondary main-preview">
                        <span class="icon"></span> È¢ÑËßà
                    </button>
                    <button onclick="Download(Download3)" class="btn-tiny backup-btn">Â§áÁî®ÊñπÊ°à A</button>
                </div>
            </div>

            <!-- ‰∏ªËÆæÁΩÆÈù¢Êùø -->
            <div class="glass-card control-panel">
                <ul class="setDataList">
                    <!-- Áî®Êà∑‰ø°ÊÅØ -->
                    <div class="input-group">
                        <div class="group-title">Âü∫Êú¨‰ø°ÊÅØ</div>
                        <li>
                            <label>Áî®Êà∑Âêç</label>
                            <input id="inpt_username" onchange="setData()" type="text" placeholder="ËæìÂÖ•ÊòµÁß∞">
                        </li>
                        <li>
                            <label>Â§¥ÂÉè</label>
                            <div class="file-action-row">
                                <button onclick="inpt_portrait_onClick()" class="btn-small">‰∏ä‰º†</button>
                                <button onclick="init_portrait()" class="btn-text">ÊÅ¢Â§çÈªòËÆ§</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_portrait" onchange="portrait_inpt()" />
                            </div>
                        </li>
                        <li>
                            <label>Ê†áÈ¢ò</label>
                            <div class="input-with-prefix">
                                <span class="prefix">keep ‚Ä¢ </span>
                                <input id="inpt_keep_title" onchange="setData()" type="text" placeholder="Êà∑Â§ñË∑ëÊ≠•">
                            </div>
                        </li>
                    </div>

                    <!-- ËøêÂä®Êï∞ÊçÆ -->
                    <div class="input-group">
                        <div class="group-title">ËøêÂä®Êï∞ÊçÆ</div>
                        <li>
                            <label>ÈáåÁ®ã (km)</label>
                            <input id="inpt_miles" onchange="setData()" type="text" class="font-mono" placeholder="0.00">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">ÈöèÊú∫ËåÉÂõ¥:</span>
                            <input type="text" id="min_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Min">
                            <span class="dash">-</span>
                            <input type="text" id="max_miles" onchange="set_km_and_speed()" class="mini-input" placeholder="Max">
                        </div>

                        <li style="margin-top: 12px;">
                            <label>ÈÖçÈÄü</label>
                            <input id="inpt_speeds" onchange="setData()" type="text" class="font-mono" placeholder="5'30&quot;">
                        </li>
                        <div class="sub-setting">
                            <span class="sub-label">ÈöèÊú∫ËåÉÂõ¥:</span>
                            <input type="text" id="min_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="Âø´">
                            <span class="dash">-</span>
                            <input type="text" id="max_speeds" onchange="set_km_and_speed()" class="mini-input" placeholder="ÊÖ¢">
                        </div>
                    </div>

                    <!-- Êó∂Èó¥‰∏éÁéØÂ¢É -->
                    <div class="input-group">
                        <div class="group-title">Êó∂Èó¥‰∏éÁéØÂ¢É</div>
                        <li>
                            <label>Êó∂Èó¥</label>
                            <div class="datetime-row">
                                <input id="inpt_year" onchange="setData()" type="text" class="year-inp"><span>/</span>
                                <input id="inpt_month" onchange="setData()" type="text" class="date-inp"><span>/</span>
                                <input id="inpt_day" onchange="setData()" type="text" class="date-inp">
                                <span class="spacer"></span>
                                <input id="inpt_hour" onchange="setData()" type="text" class="time-inp"><span>:</span>
                                <input id="inpt_min" onchange="setData()" type="text" class="time-inp">
                            </div>
                        </li>
                        <li>
                            <label>Â§©Ê∞î</label>
                            <select onchange="weather_Select_onChange()" id="weather_Select">
                                <option value="images/weather1.png">Êô¥</option>
                                <option value="images/weather2.png">Â§ö‰∫ë</option>
                                <option value="images/weather3.png">Èò¥Â§©</option>
                            </select>
                        </li>
                        <li>
                            <label>Ê∏©ÊπøÂ∫¶</label>
                            <div class="dual-input">
                                <input id="inpt_temperature" onchange="setData()" type="text" class="mini-input" placeholder="¬∞C">
                                <span class="unit">¬∞C</span>
                                <input id="inpt_humidity" onchange="setData()" type="text" class="mini-input" placeholder="%">
                                <span class="unit"></span>
                            </div>
                        </li>
                    </div>

                    <!-- Âú∞Âõæ‰∏éËΩ®Ëøπ -->
                    <div class="input-group">
                        <div class="group-title">Âú∞Âõæ‰∏éËΩ®Ëøπ</div>
                        <li>
                            <label>ËÉåÊôØ</label>
                            <select onchange="default_bgImgSelect_onChange()" id="default_bgImgSelect">
                                <option value="guiji_Select_1">Âçó‰ΩìËÇ≤Âú∫</option>
                                <option value="guiji_Select_2">ÂÜõÂ∑•ÊìçÂú∫</option>
                                <option value="guiji_Select_3">Âåó‰ΩìËÇ≤Âú∫</option>
                            </select>
                        </li>
                        <li>
                            <label>Ëá™ÂÆö‰πâ</label>
                            <div class="file-action-row">
                                <button onclick="inpt_bgimg_onClick()" class="btn-small">‰∏ä‰º†Âú∞Âõæ</button>
                                <button onclick="init_bgimg()" class="btn-text">ÈáçÁΩÆ</button>
                                <input style="display:none;" type="file" accept="image/*" id="inpt_bgimg" onchange="bgimg_inpt()" />
                            </div>
                        </li>

                        <li>
                            <label>Ê†∑Âºè</label>
                            <div class="flex-group" style="display:flex; gap:8px; align-items:center; flex:1;">
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_1" class="guijiSelect">
                                    <option value="['images/bg1_1.png', 'images/bg1_empty2.png']">Ê†∑Âºè 1</option>
                                    <option value="['images/bg1_2.png', 'images/bg1_empty2.png']">Ê†∑Âºè 2</option>
                                    <option value="['images/bg1_3.png', 'images/bg1_empty2.png']">Ê†∑Âºè 3</option>
                                    <option value="['images/bg1_4.png', 'images/bg1_empty2.png']">Ê†∑Âºè 4</option>
                                    <option value="['images/bg1_5.png', 'images/bg1_empty2.png']">Ê†∑Âºè 5</option>
                                    <option value="['images/bg1_empty2.png', 'images/bg1_empty2.png']">ÈªòËÆ§</option>
                                </select>
                                <button onclick="drawMine()" class="btn-small btn-secondary" title="ÁîüÊàêÈöèÊú∫Ë∑ØÂæÑ">ÈöèÊú∫</button>
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_2" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg2_empty.png', 'images/bg2_empty.png']">ÈªòËÆ§</option>
                                </select>
                                <select onchange="guijiSelect_onChange()" id="guiji_Select_3" class="guijiSelect" style="display:none;">
                                    <option value="['images/bg3_empty.png', 'images/bg3_empty.png']">ÈªòËÆ§</option>
                                </select>
                            </div>
                        </li>

                        <li class="switch-row">
                            <div class="switch-item">
                                <input type="checkbox" id="auto_draw_checkbox" onchange="auto_draw_checkbox_onchange()" checked />
                                <span>Ëá™Âä®ÁîüÊàê</span>
                            </div>
                            <div class="switch-item">
                                <input type="checkbox" id="inpt_colorchange_checkbox" onchange="inpt_colorchange_checkbox_onchange()" checked />
                                <span>Ê∏êÂèòËâ≤</span>
                            </div>
                        </li>
                        <div class="sub-setting" id="bs_prop_inpt_wrap">
                            <span class="sub-label">ÂèòËâ≤Ê¶ÇÁéá:</span>
                            <input id="inpt_bs_prob" onchange="setData()" type="text" class="mini-input" placeholder="0.5">
                        </div>
                        <div class="sub-setting" id="inpt_bs_range_wrap">
                            <span class="sub-label">ÂèòËâ≤Ê≠•Èïø:</span>
                            <input id="inpt_bs_range_min" onchange="setData()" type="text" class="mini-input">
                            <span class="dash">-</span>
                            <input id="inpt_bs_range_max" onchange="setData()" type="text" class="mini-input">
                        </div>
                    </div>

                    <!-- ËæìÂá∫Â∞∫ÂØ∏ -->
                    <div class="input-group no-border">
                        <li>
                            <label>ÂÆΩÂ∫¶</label>
                            <input id="inpt_savePic_width" onchange="setData()" type="text" placeholder="ÈªòËÆ§" style="min-width:80px;">
                            <span class="unit">px</span>
                        </li>
                    </div>

                </ul>

                <div class="divider"></div>
                <div class="system-actions">
                    <button onclick="storeToIndexedDB(tmp_portrait_src,tmp_bgimg_osrc)" class="btn-text">‰øùÂ≠òÈÖçÁΩÆ</button>
                    <button onclick="clearIndexedDB()" class="btn-text btn-danger-text">ÈáçÁΩÆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS ÂºïÁî® -->
    <script src="js/invoke/html2canvas.min.js" defer></script>
    <script src="js/invoke/amapHelper.js" defer></script>
    <script src="js/indexedDB.js" defer></script>
    <script src="js/init.js" defer></script>
    <script src="js/render.js" defer></script>
    <script src="js/select_manner.js" defer></script>
    <script src="js/dataURLtoBlob.js" defer></script>
    <script src="js/img_both_inpt_set.js" defer></script>
    <script src="js/draw_personalization.js" defer></script>
    <!-- Ê≥®ÊÑèÔºödownload_img.js ÈáåÁöÑÂáΩÊï∞‰ºöË¢´‰∏ãÈù¢ÁöÑËÑöÊú¨Ë¶ÜÁõñÔºåËøôÊòØÊ≠£Â∏∏ÁöÑ -->
    <script src="js/download_img.js" defer></script>
    <script src="js/localTrackGen.js"></script>
    <script src="js/drawMine.js" defer></script>
    <script src="js/onload.js" defer></script>

    <!-- üåü ÁªàÊûÅ‰øÆÂ§çÔºöÁ¶ªÂ±èÂÖãÈöÜÁîüÊàêÂô® -->
    <script>
        window.addEventListener('load', function() {
            console.log("Liquid Fix: Off-screen renderer loaded.");

            // Ë¶ÜÁõñÂéüÊúâÁöÑ Download ÂáΩÊï∞
            window.Download = function(fileNameArg) {
                const targetNode = document.getElementById('new-Img');
                if (!targetNode) return;

                // 1. ÂàõÂª∫ÂπΩÁÅµÂÆπÂô® (Ghost Container)
                // Ëøô‰∏™ÂÆπÂô®‰Ωç‰∫éÂ±èÂπïÂ§ñÔºåÁî®‰∫éÊîæÁΩÆÊàë‰ª¨ÁöÑÂÖãÈöÜ‰Ωì
                const ghostWrapper = document.createElement('div');
                ghostWrapper.style.position = 'fixed';
                ghostWrapper.style.top = '-9999px';
                ghostWrapper.style.left = '-9999px';
                ghostWrapper.style.zIndex = '-1000';
                // ÈîÅÂÆöÂÆΩÂ∫¶ÔºåÈò≤Ê≠¢Âõ†ÂÆπÂô®ÂèòÂåñÂØºËá¥ÂÜÖÂÆπÊç¢Ë°å
                ghostWrapper.style.width = targetNode.offsetWidth + 'px';
                document.body.appendChild(ghostWrapper);

                // 2. Ê∑±Â∫¶ÂÖãÈöÜËäÇÁÇπ
                const clonedNode = targetNode.cloneNode(true);

                // 3. ÂÖ≥ÈîÆÔºöÊâãÂä®ÈáçÁªò Canvas ÂÜÖÂÆπ
                // cloneNode ‰∏ç‰ºöÂ§çÂà∂ canvas ÁöÑÁªòÂõæÁä∂ÊÄÅÔºåÂøÖÈ°ªÊâãÂä®ÊääÂéüÂõæÁîªËøáÂéª
                const originalCanvases = targetNode.querySelectorAll('canvas');
                const clonedCanvases = clonedNode.querySelectorAll('canvas');
                originalCanvases.forEach((orig, index) => {
                    if (clonedCanvases[index]) {
                        const destCtx = clonedCanvases[index].getContext('2d');
                        // Á°Æ‰øùÂ∞∫ÂØ∏‰∏ÄËá¥
                        clonedCanvases[index].width = orig.width;
                        clonedCanvases[index].height = orig.height;
                        destCtx.drawImage(orig, 0, 0);
                    }
                });

                // 4. ÂáÄÂåñÂÖãÈöÜ‰ΩìÊ†∑Âºè
                // ËøôÈáåÁßªÈô§ÊâÄÊúâÂØºËá¥ html2canvas Â¥©Ê∫ÉÁöÑÁâπÊïà
                clonedNode.style.transform = 'none';       // ÁßªÈô§Áº©Êîæ
                clonedNode.style.boxShadow = 'none';       // ÁßªÈô§Èò¥ÂΩ±
                clonedNode.style.margin = '0';             // ÁßªÈô§ËæπË∑ù
                clonedNode.style.transition = 'none';      // ÁßªÈô§Âä®Áîª
                
                // Á°Æ‰øùËÉåÊôØÊ≠£Á°Æ (Èò≤Ê≠¢ËÉåÊôØÈÄèÊòéÂèòÈªë)
                if (getComputedStyle(targetNode).backgroundColor === 'rgba(0, 0, 0, 0)') {
                   // Â¶ÇÊûúÂéüËÉåÊôØÈÄèÊòéÔºå‰øùÊåÅÈÄèÊòéÊàñËÆæ‰∏∫ÁôΩËâ≤ÔºåËßÜÈúÄÊ±ÇËÄåÂÆö
                }

                ghostWrapper.appendChild(clonedNode);

                // 5. Á°ÆÂÆöÊñá‰ª∂Âêç
                let fileName = "HEU_Run_" + new Date().toISOString().slice(0,10) + ".png";
                // ÂÖºÂÆπÂéü‰ª£Á†Å‰º†ÂÖ•ÁöÑ Download1 ÂáΩÊï∞ÊàñÂ≠óÁ¨¶‰∏≤
                if (typeof fileNameArg === 'function') {
                    try { fileName = fileNameArg(); } catch (e) {}
                } else if (typeof fileNameArg === 'string') {
                    fileName = fileNameArg;
                }
                // Á°Æ‰øùÂêéÁºÄÂêç
                if (!fileName.endsWith('.png')) fileName += '.png';

                // 6. Ë∞ÉÁî® html2canvas
                // Âõ†‰∏∫ÂÖãÈöÜ‰ΩìÊ≤°ÊúâÁâπÊïàÔºåËøôÈáåÊ∏≤Êüì‰ºöÈùûÂ∏∏Âø´‰∏îÂáÜÁ°Æ
                html2canvas(clonedNode, {
                    scale: 2,          // 2ÂÄçÈ´òÊ∏Ö
                    useCORS: true,     // Ë∑®ÂüüÊîØÊåÅ
                    backgroundColor: null, // ‰øùÊåÅÈÄèÊòéËÉåÊôØ
                    logging: false
                }).then(canvas => {
                    // 7. Ëß¶Âèë‰∏ãËΩΩ
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 8. Ê∏ÖÁêÜ
                    document.body.removeChild(ghostWrapper);
                    console.log("Download success.");
                }).catch(err => {
                    console.error("ÁîüÊàêÂ§±Ë¥•:", err);
                    alert("ÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÂõæÁâáË∑®ÂüüËÆæÁΩÆ");
                    if (document.body.contains(ghostWrapper)) {
                        document.body.removeChild(ghostWrapper);
                    }
                });
            };
        });
    </script>
</body>
</html>